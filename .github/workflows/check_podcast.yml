name: Check & Auto-Publish Podcast

on:
  schedule:
    - cron: '*/15 * * * *'  # Ki·ªÉm tra m·ªói 15 ph√∫t
  workflow_dispatch:  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub UI

jobs:
  check-podcast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq chromium-chromedriver
          pip install playwright
          playwright install chromium

      - name: Check Podcast Status
        run: |
          PODCAST_URL="https://podcasts.apple.com/us/podcast/backlink1dpod/id1786769245"
          TELEGRAM_TOKEN="${{ secrets.TELEGRAM_TOKEN }}"
          CHAT_ID="${{ secrets.CHAT_ID }}"

          echo "üîç Checking Podcast Status..."
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" $PODCAST_URL)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ Podcast ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!"
          else
            echo "‚ùå Podcast kh√¥ng ho·∫°t ƒë·ªông, c·∫ßn publish l·∫°i!"
            curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id=$CHAT_ID \
              -d text="‚ö† Podcast b·ªã l·ªói: c·∫ßn publish l·∫°i!"

            # K√≠ch ho·∫°t workflow publish_podcast.yml
            curl -X POST -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/publish_podcast.yml/dispatches \
              -d '{"ref":"main"}'
